{% block title %}Intercambiar/Donar KLV{% endblock %}

{% block content %}
    <!-- 
        El widget de React requiere sus propios CDNs de Tailwind, React y Babel, 
        que se incluyen aquí para que solo carguen cuando se renderice esta página.
    -->
    <!-- Incluye Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para colores personalizados de Klever Chain en Tailwind -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'klv-green': '#00B894',
              'klv-dark': '#1C1C1C',
              'klv-blue': '#2152ff',
            }
          }
        }
      }
    </script>
    <!-- Importamos React y ReactDOM desde CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Importamos Babel para transpilar el JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Contenedor del Widget de Donación -->
    <div id="root" class="py-12">
        <div class="text-center p-10 text-gray-500">Cargando aplicación Widget...</div>
    </div>
{% endblock %}

{% block javascripts %}
    <script type="text/babel">
        // Acceso a Hooks de React desde el objeto global
        const { useState, useEffect, useCallback } = React;

        // --- Componentes de Iconos SVG Nativos ---
        
        const Icon = ({ children, size = 24, className = "" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width={size} 
                height={size} 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round"
                className={className}
            >
                {children}
            </svg>
        );

        const Wallet = (props) => (
            <Icon {...props}>
                <path d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5"/>
                <path d="M21 12h-7a2 2 0 0 1-2-2V7"/>
                <path d="M16 16h2"/>
            </Icon>
        );

        const Info = (props) => (
            <Icon {...props}>
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </Icon>
        );

        const CheckCircle = (props) => (
            <Icon {...props}>
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <path d="M22 4 12 14.01l-3-3"/>
            </Icon>
        );

        const AlertTriangle = (props) => (
            <Icon {...props}>
                <path d="M10.29 3.86 1.84 18a2 2 0 0 0 1.71 3h16.89a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <path d="M12 9v4"/>
                <path d="M12 17h.01"/>
            </Icon>
        );

        const Loader2 = (props) => (
            <Icon {...props}>
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </Icon>
        );

        const Zap = (props) => (
            <Icon {...props}>
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
            </Icon>
        );
        // --- FIN Componentes de Iconos SVG ---


        // --- Configuración de Colores y Constantes ---
        const KLV_COLORS = {
            green: '#00B894',
            dark: '#1C1C1C',
            blue: '#2152ff',
            // Definiciones de Tailwind
            blueText: 'text-[#2152ff]',
            blueBorder: 'border-[#2152ff]',
            blueBg: 'bg-[#2152ff]',
            blueHover: 'hover:bg-[#2152ff]/90',
            darkBg: 'bg-[#1C1C1C]',
            darkHover: 'hover:bg-[#1C1C1C]/80',
            greenBg: 'bg-[#00B894]',
            greenText: 'text-[#00B894]',
        };

        const MAX_RETRIES = 15;
        const RETRY_DELAY_MS = 250;
        const BOOTSTRAP_DELAY_MS = 1000;

        // --- Funciones de Lógica de Conexión (sin cambios) ---

        /**
         * Hook personalizado para manejar la lógica de conexión de la Klever Wallet.
         */
        const useWalletConnection = () => {
            const [walletAddress, setWalletAddress] = useState(null);
            const [connectionStatus, setConnectionStatus] = useState({
                title: 'Listo para Conectar',
                message: 'Conéctate para donar usando KleverChain.',
                type: 'info', // 'info', 'success', 'error'
            });
            const [isLoading, setIsLoading] = useState(false);

            const connectWallet = useCallback(async () => {
                setIsLoading(true);
                setConnectionStatus({
                    title: 'Buscando Extensión',
                    message: 'Buscando Klever Wallet...',
                    type: 'info',
                });

                try {
                    // Función para esperar a que window.kleverWeb esté disponible
                    const waitForKleverWeb = async () => {
                        await new Promise(resolve => setTimeout(resolve, BOOTSTRAP_DELAY_MS));
                        for (let i = 0; i < MAX_RETRIES; i++) {
                            if (window.kleverWeb && typeof window.kleverWeb.getAccounts === 'function') {
                                console.log(`[KleverChain] Extensión detectada en el intento ${i + 1}.`);
                                return true;
                            }
                            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                        }
                        console.error('[KleverChain] ERROR CRÍTICO: La extensión Klever no fue detectada.');
                        return false;
                    };

                    if (!(await waitForKleverWeb())) {
                        throw new Error("Extensión Klever Wallet no detectada.");
                    }

                    setConnectionStatus({
                        title: 'Solicitando Conexión',
                        message: 'Por favor, aprueba la conexión en la ventana emergente.',
                        type: 'info',
                    });

                    // Ejecutar la función de la extensión
                    const accounts = await window.kleverWeb.getAccounts();

                    if (accounts && accounts.length > 0) {
                        const address = accounts[0].address;
                        setWalletAddress(address);
                        setConnectionStatus({
                            title: '¡Conexión Exitosa!',
                            message: 'Dirección conectada. ¡Lista para donar!',
                            type: 'success',
                        });
                    } else {
                        setConnectionStatus({
                            title: 'Conexión Rechazada',
                            message: 'El usuario canceló la solicitud.',
                            type: 'error',
                        });
                    }
                } catch (error) {
                    console.error('[KleverChain] Error al conectar la Wallet:', error);
                    const displayMessage = error.message.includes('Extensión Klever Wallet no detectada')
                        ? 'No se pudo encontrar la extensión.'
                        : `Error: ${error.message}`;

                    setConnectionStatus({
                        title: 'Fallo de Conexión',
                        message: displayMessage,
                        type: 'error',
                    });
                } finally {
                    setIsLoading(false);
                }
            }, []);

            return { walletAddress, connectionStatus, connectWallet, isLoading };
        };

        // --- Componentes de UI ---

        /**
         * Componente de la Tarjeta de Estado de Conexión
         */
        const StatusCard = ({ status, walletAddress }) => {
            const IconComponent = status.type === 'success' ? CheckCircle : (status.type === 'error' ? AlertTriangle : Info);
            const cardBorderClass = status.type === 'success' ? 'border-klv-green' : (status.type === 'error' ? 'border-red-600' : 'border-klv-blue');
            const iconColorClass = status.type === 'success' ? KLV_COLORS.greenText : (status.type === 'error' ? 'text-red-600' : KLV_COLORS.blueText);

            return (
                <div className={`w-full p-4 bg-white rounded-xl shadow-lg border-l-4 ${cardBorderClass} transition duration-300 ease-in-out`}>
                    <div className="flex items-start space-x-3">
                        <IconComponent size={20} className={`flex-shrink-0 mt-0.5 ${iconColorClass}`} />
                        <div className="text-sm">
                            <h2 className="font-semibold text-gray-900">{status.title}</h2>
                            <p className="text-gray-500">{status.message}</p>
                            {walletAddress && (
                                <p className="mt-1 text-xs font-mono text-gray-700 overflow-hidden truncate">Addr: {walletAddress}</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        /**
         * Componente principal del Widget de Donación
         */
        const DonationWidget = ({ walletAddress, connectWallet, isLoading, connectionStatus }) => {
            const [amount, setAmount] = useState(10);
            const [isSending, setIsSending] = useState(false);
            const [txStatus, setTxStatus] = useState(null); // 'pending', 'success', 'error'
            const [message, setMessage] = useState('');

            // Función simulada de envío de transacción (aquí iría la lógica real de KleverWeb)
            const handleDonate = async () => {
                if (!walletAddress || !window.kleverWeb) {
                    setMessage("Por favor, conecta tu wallet primero.");
                    return;
                }

                setIsSending(true);
                setTxStatus('pending');
                setMessage('Iniciando transacción. Por favor, confirma en tu Wallet...');

                try {
                    // --- SIMULACIÓN DE TRANSACCIÓN ---
                    // En un DApp real, usarías kleverWeb.sendTransaction() o similar.
                    await new Promise(resolve => setTimeout(resolve, 3000)); 

                    // Simular éxito o fallo
                    if (Math.random() > 0.1) { // 90% de éxito
                        setTxStatus('success');
                        setMessage(`¡Donación de ${amount} KLV enviada con éxito! Gracias por tu contribución transparente.`);
                        setAmount(10); // Reset
                    } else {
                        throw new Error("Transacción fallida por motivos de red simulados.");
                    }
                    // --- FIN SIMULACIÓN ---
                } catch (error) {
                    console.error("Error de donación:", error);
                    setTxStatus('error');
                    setMessage(`Fallo al enviar la donación. ${error.message}`);
                } finally {
                    setIsSending(false);
                }
            };

            const isConnected = !!walletAddress;
            const isReadyToDonate = isConnected && !isSending && connectionStatus.type === 'success';

            return (
                <div className="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-sm mx-auto transform transition-all duration-500 hover:scale-[1.01] border border-gray-100">
                    <h1 className={`${KLV_COLORS.blueText} text-2xl font-bold mb-4 flex items-center`}>
                        <Zap size={24} className="mr-2"/> Donación KLV Rápida
                    </h1>
                    <p className="text-gray-600 mb-6 text-sm">
                        Apoya nuestro proyecto con KLV a través de KleverChain.
                    </p>

                    {/* 1. Estatus de Conexión */}
                    <div className="mb-6">
                        <StatusCard status={connectionStatus} walletAddress={walletAddress} />
                    </div>

                    {/* 2. Formulario de Donación */}
                    <div className="space-y-4">
                        <label htmlFor="amount" className="block text-sm font-medium text-gray-700">
                            Cantidad a donar (KLV)
                        </label>
                        <input
                            type="number"
                            id="amount"
                            value={amount}
                            onChange={(e) => setAmount(Number(e.target.value))}
                            min="1"
                            step="1"
                            disabled={!isConnected || isSending}
                            className={`w-full p-3 border-2 rounded-lg text-lg font-mono focus:ring-klv-blue focus:border-klv-blue transition duration-150 ${!isConnected ? 'bg-gray-100' : 'border-gray-300'}`}
                        />

                        {/* Botones de atajo */}
                        <div className="flex justify-between space-x-2">
                            {[5, 10, 25].map(val => (
                                <button
                                    key={val}
                                    onClick={() => setAmount(val)}
                                    disabled={!isConnected || isSending}
                                    className={`flex-1 py-1 text-sm rounded-full transition duration-150 ${
                                        amount === val ? KLV_COLORS.greenBg + ' text-white shadow-md' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    {val} KLV
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* 3. Botón Principal */}
                    <button
                        onClick={isConnected ? handleDonate : connectWallet}
                        disabled={isSending || isLoading || (isConnected && amount <= 0)}
                        className={`mt-6 w-full py-3 text-white font-bold rounded-lg shadow-lg transition duration-300 flex items-center justify-center ${
                            !isConnected ? KLV_COLORS.blueBg + ' ' + KLV_COLORS.blueHover : 
                            (isSending ? 'bg-gray-400 cursor-not-allowed' : KLV_COLORS.greenBg + ' hover:bg-klv-green/90')
                        }`}
                    >
                        {isSending || isLoading ? (
                            <Loader2 size={18} className="animate-spin mr-2" />
                        ) : (
                            <Wallet size={18} className="mr-2" />
                        )}
                        {isSending ? 'Enviando...' : (isConnected ? `Donar ${amount} KLV` : 'Conectar Klever Wallet')}
                    </button>

                    {/* 4. Mensaje de estado de TX */}
                    {message && (
                        <div className={`mt-4 p-3 rounded-lg text-sm ${
                            txStatus === 'success' ? 'bg-klv-green/10 text-klv-green' :
                            txStatus === 'error' ? 'bg-red-100 text-red-600' :
                            'bg-blue-100 text-blue-600'
                        }`}>
                            {message}
                        </div>
                    )}
                </div>
            );
        };

        /**
         * Componente Principal de la Aplicación (minimalista)
         */
        const App = () => {
            const { walletAddress, connectionStatus, connectWallet, isLoading } = useWalletConnection();
            
            return (
                <div className="bg-gray-50 font-sans antialiased min-h-screen flex items-center justify-center p-4">
                    <DonationWidget 
                        walletAddress={walletAddress}
                        connectionStatus={connectionStatus}
                        connectWallet={connectWallet}
                        isLoading={isLoading}
                    />
                </div>
            );
        };
        
        // --- INICIALIZACIÓN DE REACT ---
        const container = document.getElementById('root');
        // Esperamos a que el DOM esté completamente cargado (aunque en este contexto Babel lo maneja)
        document.addEventListener('DOMContentLoaded', () => {
            const root = ReactDOM.createRoot(container);
            root.render(<App />);
        });
    </script>
{% endblock %}
