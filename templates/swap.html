{% extends 'base.html' %}

{% block title %}Intercambiar/Donar KLV{% endblock %}

{% block content %}
    <!-- Contenedor del Widget de Donación (React) -->
    <div id="root" class="py-12 flex items-center justify-center min-h-screen-75">
        <div class="text-center p-10 text-xl font-mono text-klv-blue animate-pulse">
            Cargando aplicación Widget...
        </div>
    </div>

    <!-- Las dependencias de Frontend para el Widget (solo se cargan aquí) -->
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Configuración de colores personalizados de Tailwind CSS
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'klv-green': '#00B894',
              'klv-dark': '#1C1C1C',
              'klv-blue': '#2152ff',
            }
          }
        }
      }
    </script>
    <!-- Dependencias de React y Babel para el JSX -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
{% endblock %}

{% block javascripts %}
    <!-- Lógica de la aplicación React (Widget de Donación) -->
    <script type="text/babel">
        // Importación de funciones necesarias desde los módulos globales
        const { useState, useEffect } = React;
        const KLV_TOKEN_ID = '0x4332D6E8B907873D440498b36873A2A8557F265C'; 

        // --------------------------------------------------------------------------------
        // 1. Hook para manejar la conexión y los datos de la billetera (wallet_connection.js)
        // --------------------------------------------------------------------------------
        const useWalletConnection = () => {
            const [walletAddress, setWalletAddress] = useState(null);
            const [klvBalance, setKlvBalance] = useState(0);

            useEffect(() => {
                const updateWalletState = () => {
                    const address = window.getWalletAddress ? window.getWalletAddress() : null;
                    const balance = window.getKlvBalance ? window.getKlvBalance() : 0;
                    setWalletAddress(address);
                    setKlvBalance(balance);
                };

                // Suscribirse a los eventos después de que el script wallet_connection.js cargue
                if (window.addEventListener) {
                    window.addEventListener('walletConnected', updateWalletState);
                    window.addEventListener('walletDisconnected', updateWalletState);
                    window.addEventListener('balanceUpdated', updateWalletState);
                }
                
                // Inicializar el estado
                updateWalletState();

                // Limpiar los listeners
                return () => {
                    if (window.removeEventListener) {
                        window.removeEventListener('walletConnected', updateWalletState);
                        window.removeEventListener('walletDisconnected', updateWalletState);
                        window.removeEventListener('balanceUpdated', updateWalletState);
                    }
                };
            }, []);

            const connectWallet = () => {
                if (window.connectWallet) {
                    window.connectWallet();
                } else {
                    console.error("connectWallet function not found in window object.");
                }
            };

            return { walletAddress, klvBalance, connectWallet };
        };

        // --------------------------------------------------------------------------------
        // 2. Componente principal del Widget de Donación/Swap
        // --------------------------------------------------------------------------------
        const DonationWidget = ({ walletAddress, klvBalance }) => {
            const [amount, setAmount] = useState('');
